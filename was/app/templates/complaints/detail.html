{% extends 'base.html' %}
{% block title %}민원 상세{% endblock %}
{% block content %}
<div class="card">
  <p class="eyebrow">Complaint #{{ complaint.id }}</p>
  <h2>{{ complaint.title }}</h2>

  <!-- Progress Stepper -->
  <div class="stepper">
    {% set status_order = ['received', 'in_review', 'resolved'] %}
    {% set current_idx = status_order.index(complaint.status) if complaint.status in status_order else -1 %}
    {% set is_rejected = complaint.status == 'rejected' %}

    <!-- Step 1: 접수 -->
    <div class="stepper-step {% if current_idx >= 0 %}completed{% endif %}{% if current_idx == 0 and not is_rejected %} active{% endif %}">
      <div class="stepper-connector"></div>
      <div class="stepper-icon">
        {% if current_idx > 0 or is_rejected %}
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        {% else %}
          1
        {% endif %}
      </div>
      <div class="stepper-label">접수완료</div>
      <div class="stepper-date">{{ complaint.created_at.strftime('%m/%d %H:%M') }}</div>
    </div>

    <!-- Step 2: 검토중 -->
    <div class="stepper-step {% if current_idx >= 1 %}completed{% endif %}{% if current_idx == 1 and not is_rejected %} active{% endif %}{% if is_rejected %} rejected{% endif %}">
      <div class="stepper-connector"></div>
      <div class="stepper-icon">
        {% if current_idx > 1 %}
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        {% elif is_rejected %}
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        {% else %}
          2
        {% endif %}
      </div>
      <div class="stepper-label">{% if is_rejected %}반려{% else %}검토중{% endif %}</div>
      {% if current_idx >= 1 or is_rejected %}
        <div class="stepper-date">{{ complaint.updated_at.strftime('%m/%d %H:%M') if complaint.updated_at else '-' }}</div>
      {% endif %}
    </div>

    <!-- Step 3: 처리완료 -->
    <div class="stepper-step {% if current_idx >= 2 %}completed{% endif %}{% if current_idx == 2 %} active{% endif %}">
      <div class="stepper-icon">
        {% if current_idx >= 2 %}
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        {% else %}
          3
        {% endif %}
      </div>
      <div class="stepper-label">처리완료</div>
      {% if current_idx >= 2 %}
        <div class="stepper-date">{{ complaint.updated_at.strftime('%m/%d %H:%M') if complaint.updated_at else '-' }}</div>
      {% endif %}
    </div>
  </div>

  <!-- Status Summary -->
  <div class="status-summary">
    <div class="status-summary-icon {{ complaint.status }}">
      {% if complaint.status == 'received' %}
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#166534" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      {% elif complaint.status == 'in_review' %}
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#854d0e" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
      {% elif complaint.status == 'resolved' %}
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1d4ed8" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      {% elif complaint.status == 'rejected' %}
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#b91c1c" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>
      {% endif %}
    </div>
    <div class="status-summary-text">
      <h4>
        {% if complaint.status == 'received' %}
          민원이 접수되었습니다
        {% elif complaint.status == 'in_review' %}
          담당자가 검토 중입니다
        {% elif complaint.status == 'resolved' %}
          민원 처리가 완료되었습니다
        {% elif complaint.status == 'rejected' %}
          민원이 반려되었습니다
        {% endif %}
      </h4>
      <p>
        {% if complaint.status == 'received' %}
          곧 담당자가 배정되어 검토가 시작됩니다.
        {% elif complaint.status == 'in_review' %}
          처리 결과는 이 페이지에서 확인하실 수 있습니다.
        {% elif complaint.status == 'resolved' %}
          추가 문의사항이 있으시면 새 민원을 접수해주세요.
        {% elif complaint.status == 'rejected' %}
          반려 사유는 담당자에게 문의해주세요.
        {% endif %}
      </p>
    </div>
  </div>
</div>

<div class="card">
  <p class="eyebrow">Details</p>
  <h3>민원 상세 내용</h3>
  <p><strong>카테고리:</strong> {{ complaint_category_labels.get(complaint.category, complaint.category) }}</p>
  <p class="small">접수일: {{ complaint.created_at.strftime('%Y-%m-%d %H:%M') }}{% if complaint.updated_at %} | 최종 수정: {{ complaint.updated_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}</p>
  {% if complaint.assigned_admin %}
    <p class="small">담당자: {{ complaint.assigned_admin.username }}</p>
  {% endif %}
  <div class="card" style="margin-top: 12px; background: var(--surface-soft); box-shadow: none;">
    <p style="white-space: pre-wrap; margin: 0;">{{ complaint.content }}</p>
  </div>
</div>

{% if current_user.role == 'admin' %}
<div class="card" style="max-width: 520px;">
  <p class="eyebrow">Admin Process</p>
  <h3>처리 상태 변경</h3>
  <form class="form" method="post">
    <label>상태
      <select name="status">
        <option value="received" {% if complaint.status == 'received' %}selected{% endif %}>접수 (received)</option>
        <option value="in_review" {% if complaint.status == 'in_review' %}selected{% endif %}>검토중 (in_review)</option>
        <option value="resolved" {% if complaint.status == 'resolved' %}selected{% endif %}>처리완료 (resolved)</option>
        <option value="rejected" {% if complaint.status == 'rejected' %}selected{% endif %}>반려 (rejected)</option>
      </select>
    </label>
    <button type="submit">상태 변경</button>
  </form>
</div>
{% endif %}

<div class="inline-actions">
  <a class="btn btn-subtle" href="{{ url_for('complaints_list') }}">목록으로</a>
</div>
{% endblock %}
