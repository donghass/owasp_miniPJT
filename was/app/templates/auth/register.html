{% extends 'base.html' %}
{% block title %}회원가입 | 공공 의료 민원 포털{% endblock %}
{% block content %}
<div class="card auth-card" style="max-width: 700px;">
  <div class="auth-header">
    <p class="eyebrow">Onboarding</p>
    <h2>사용자 등록</h2>
    <p class="small">중복 확인과 약관 동의 후 계정을 생성할 수 있습니다.</p>
  </div>

  <form class="form" method="post" id="register-form" novalidate>
    <div class="form-group">
      <label for="reg-username">아이디</label>
      <div class="inline-actions form-inline-check">
        <div class="input-icon-wrap" style="flex: 1;">
          <span class="field-icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
          </span>
          <input id="reg-username" name="username" type="text" required autocomplete="username" placeholder="영문/숫자 조합 (3자 이상)">
        </div>
        <button type="button" class="btn btn-subtle btn-check" id="check-username-btn">중복 확인</button>
      </div>
      <p id="username-check-result" class="small dup-check-message">아이디 중복 확인이 필요합니다.</p>
    </div>

    <div class="form-group">
      <label for="reg-email">이메일</label>
      <div class="inline-actions form-inline-check">
        <div class="input-icon-wrap" style="flex: 1;">
          <span class="field-icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
              <polyline points="22,6 12,13 2,6"/>
            </svg>
          </span>
          <input id="reg-email" name="email" type="email" required autocomplete="email" placeholder="example@email.com">
        </div>
        <button type="button" class="btn btn-subtle btn-check" id="check-email-btn">중복 확인</button>
      </div>
      <p id="email-check-result" class="small dup-check-message">이메일 중복 확인이 필요합니다.</p>
    </div>

    <div class="form-group">
      <label for="reg-full-name">이름</label>
      <div class="input-icon-wrap">
        <span class="field-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
               fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
        </span>
        <input id="reg-full-name" name="full_name" type="text" required autocomplete="name" placeholder="실명을 입력하세요">
      </div>
    </div>

    <div class="form-group">
      <label for="reg-phone">연락처</label>
      <div class="input-icon-wrap">
        <span class="field-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
               fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12 19.79 19.79 0 0 1 1.65 3.27 2 2 0 0 1 3.62 1h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 8.61a16 16 0 0 0 6.29 6.29l.97-.97a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/>
          </svg>
        </span>
        <input id="reg-phone" name="phone" type="tel" required autocomplete="tel" placeholder="010-0000-0000">
      </div>
    </div>

    <div class="form-group">
      <label for="reg-password">비밀번호</label>
      <div class="password-wrap">
        <span class="field-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
               fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
        </span>
        <input id="reg-password" name="password" type="password" required autocomplete="new-password" placeholder="8자 이상 입력">
        <button type="button" class="password-toggle" aria-label="비밀번호 표시/숨김" onclick="togglePassword('reg-password', this)">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
               fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
        </button>
      </div>
      <div class="field-hint">
        <span>영문, 숫자를 포함해 8자 이상 권장</span>
      </div>
    </div>

    <section class="terms-box">
      <h3>약관 동의</h3>
      <div class="terms-item">
        <label class="checkline">
          <input type="checkbox" name="agree_required_terms" id="agree-required" required>
          <span>(필수) 서비스 이용약관 및 개인정보 처리방침 동의</span>
        </label>
        <button type="button" class="btn btn-subtle btn-mini" data-open-dialog="required-terms-dialog">내용 보기</button>
      </div>
      <div class="terms-item">
        <label class="checkline">
          <input type="checkbox" name="agree_optional_terms" id="agree-optional">
          <span>(선택) 의료 마이데이터 맞춤 알림 수신 동의</span>
        </label>
        <button type="button" class="btn btn-subtle btn-mini" data-open-dialog="optional-terms-dialog">내용 보기</button>
      </div>
    </section>

    <p id="dup-check-form-message" class="small dup-check-message bad" style="display: none;"></p>
    <button type="submit" style="margin-top: 8px;">가입하기</button>
  </form>

  <div class="auth-divider">
    이미 계정이 있다면 <a href="{{ url_for('login') }}">로그인</a>하세요.
  </div>
</div>

<dialog id="required-terms-dialog" class="terms-dialog">
  <h3>서비스 이용약관/개인정보 처리방침 (필수)</h3>
  <ul>
    <li>민원 처리와 계정 운영을 위해 아이디, 이메일, 연락처를 수집합니다.</li>
    <li>수집된 정보는 민원 처리 이력 조회 및 본인 식별 목적으로 사용됩니다.</li>
    <li>법령상 보관 의무 기간 종료 시 지체 없이 파기합니다.</li>
    <li>타인 정보를 무단 등록할 수 없으며 위반 시 계정 이용이 제한될 수 있습니다.</li>
  </ul>
  <div class="inline-actions">
    <button type="button" class="btn btn-subtle" data-close-dialog="required-terms-dialog">닫기</button>
  </div>
</dialog>

<dialog id="optional-terms-dialog" class="terms-dialog">
  <h3>맞춤 알림 수신 동의 (선택)</h3>
  <ul>
    <li>예방접종 일정, 검진 안내, 공공의료 지원사업 안내 알림을 받을 수 있습니다.</li>
    <li>선택 동의 항목이며, 동의하지 않아도 서비스 기본 기능 이용이 가능합니다.</li>
    <li>마이페이지에서 언제든지 동의/철회할 수 있습니다.</li>
  </ul>
  <div class="inline-actions">
    <button type="button" class="btn btn-subtle" data-close-dialog="optional-terms-dialog">닫기</button>
  </div>
</dialog>

<script>
  (function () {
    function togglePassword(inputId, btn) {
      var input = document.getElementById(inputId);
      var isPassword = input.type === 'password';
      input.type = isPassword ? 'text' : 'password';
      btn.setAttribute('aria-label', isPassword ? '비밀번호 숨기기' : '비밀번호 표시');
      btn.innerHTML = isPassword
        ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>'
        : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
    }
    window.togglePassword = togglePassword;

    var usernameInput = document.getElementById('reg-username');
    var emailInput = document.getElementById('reg-email');
    var usernameBtn = document.getElementById('check-username-btn');
    var emailBtn = document.getElementById('check-email-btn');
    var usernameResult = document.getElementById('username-check-result');
    var emailResult = document.getElementById('email-check-result');
    var form = document.getElementById('register-form');
    var formMessage = document.getElementById('dup-check-form-message');
    var checked = { username: '', email: '' };

    function setMessage(el, text, statusClass) {
      el.textContent = text;
      el.classList.remove('ok', 'bad');
      if (statusClass) {
        el.classList.add(statusClass);
      }
    }

    function resetCheck(field) {
      checked[field] = '';
      if (field === 'username') {
        setMessage(usernameResult, '아이디 중복 확인이 필요합니다.', '');
      } else {
        setMessage(emailResult, '이메일 중복 확인이 필요합니다.', '');
      }
    }

    async function runDuplicateCheck(field, value, outputEl) {
      if (!value) {
        setMessage(outputEl, '값을 먼저 입력하세요.', 'bad');
        return;
      }
      try {
        var res = await fetch('/register/check-duplicate?field=' + encodeURIComponent(field) + '&value=' + encodeURIComponent(value));
        var data = await res.json();
        if (!res.ok || !data.ok) {
          setMessage(outputEl, data.message || '중복 확인에 실패했습니다.', 'bad');
          checked[field] = '';
          return;
        }
        if (data.available) {
          setMessage(outputEl, '사용 가능한 값입니다.', 'ok');
          checked[field] = value;
        } else {
          setMessage(outputEl, '이미 사용 중인 값입니다.', 'bad');
          checked[field] = '';
        }
      } catch (e) {
        setMessage(outputEl, '네트워크 오류로 확인에 실패했습니다.', 'bad');
        checked[field] = '';
      }
    }

    usernameBtn.addEventListener('click', function () {
      runDuplicateCheck('username', usernameInput.value.trim(), usernameResult);
    });
    emailBtn.addEventListener('click', function () {
      runDuplicateCheck('email', emailInput.value.trim(), emailResult);
    });
    usernameInput.addEventListener('input', function () {
      if (checked.username && checked.username !== usernameInput.value.trim()) {
        resetCheck('username');
      }
    });
    emailInput.addEventListener('input', function () {
      if (checked.email && checked.email !== emailInput.value.trim()) {
        resetCheck('email');
      }
    });

    form.addEventListener('submit', function (event) {
      var usernameValue = usernameInput.value.trim();
      var emailValue = emailInput.value.trim();
      formMessage.style.display = 'none';
      if (!usernameValue || !emailValue) {
        return;
      }
      if (checked.username !== usernameValue) {
        event.preventDefault();
        formMessage.textContent = '아이디 중복 확인을 완료해주세요.';
        formMessage.style.display = 'block';
        usernameInput.focus();
        return;
      }
      if (checked.email !== emailValue) {
        event.preventDefault();
        formMessage.textContent = '이메일 중복 확인을 완료해주세요.';
        formMessage.style.display = 'block';
        emailInput.focus();
      }
    });

    document.querySelectorAll('[data-open-dialog]').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var dialog = document.getElementById(btn.getAttribute('data-open-dialog'));
        if (dialog && dialog.showModal) dialog.showModal();
      });
    });
    document.querySelectorAll('[data-close-dialog]').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var dialog = document.getElementById(btn.getAttribute('data-close-dialog'));
        if (dialog) dialog.close();
      });
    });
  })();
</script>
{% endblock %}
