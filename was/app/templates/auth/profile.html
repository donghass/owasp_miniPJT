{% extends 'base.html' %}
{% block title %}마이페이지{% endblock %}
{% block content %}
{% set profile_image_url = url_for('static', filename='uploads/profiles/' ~ current_user.profile_image_name) if current_user.profile_image_name else None %}

<div class="grid grid-2">
  <section class="card">
    <p class="eyebrow">Account</p>
    <h2>내 계정 정보</h2>
    <div class="profile-header">
      {% if profile_image_url %}
      <img class="profile-avatar" src="{{ profile_image_url }}" alt="프로필 이미지">
      {% else %}
      <div class="profile-avatar profile-avatar-placeholder">{{ current_user.username[:1]|upper }}</div>
      {% endif %}
      <div>
        <p><strong>아이디</strong> {{ current_user.username }}</p>
        <p><strong>이메일</strong> {{ current_user.email }}</p>
        <p><strong>권한</strong> {{ current_user.role }}</p>
        <p class="small">생성일 {{ current_user.created_at|kst_datetime('%Y-%m-%d %H:%M') }}</p>
      </div>
    </div>
    <div class="agreement-status">
      <p class="small"><strong>필수 약관</strong> {% if current_user.required_terms_agreed %}동의{% else %}미동의{% endif %}{% if current_user.required_terms_agreed_at %} ({{ current_user.required_terms_agreed_at|kst_datetime('%Y-%m-%d %H:%M') }}){% endif %}</p>
      <p class="small"><strong>선택 약관</strong> {% if current_user.optional_terms_agreed %}동의{% else %}철회{% endif %}{% if current_user.optional_terms_agreed_at %} ({{ current_user.optional_terms_agreed_at|kst_datetime('%Y-%m-%d %H:%M') }}){% endif %}</p>
    </div>
  </section>

  <section class="card">
    <p class="eyebrow">Profile</p>
    <h2>개인정보/약관/이미지 수정</h2>
    <form class="form" method="post" enctype="multipart/form-data">
      <label>이름<input name="full_name" value="{{ current_user.full_name }}" required></label>
      <label>연락처<input name="phone" value="{{ current_user.phone }}" required></label>
      <label>이메일<input name="email" type="email" value="{{ current_user.email }}" required></label>

      <label>프로필 이미지
        <input name="profile_image" type="file" accept=".jpg,.jpeg,.png,.gif,.webp">
      </label>
      <label class="checkline">
        <input type="checkbox" name="remove_profile_image">
        기존 프로필 이미지 삭제
      </label>

      <label class="checkline">
        <input type="checkbox" name="agree_optional_terms" {% if current_user.optional_terms_agreed %}checked{% endif %}>
        (선택) 맞춤 알림 약관 동의
      </label>
      <p class="small">선택 약관은 이 체크박스로 언제든지 동의/철회할 수 있습니다.</p>

      <label>추가 인증(현재 비밀번호)
        <input name="current_password" type="password" required autocomplete="current-password" placeholder="수정을 위해 현재 비밀번호 입력">
      </label>
      <button type="submit">저장</button>
    </form>
  </section>
</div>

<div class="grid grid-2">
  <section class="card">
    <div class="split">
      <div>
        <p class="eyebrow">My Posts</p>
        <h3>내가 작성한 게시글</h3>
      </div>
      <a class="btn btn-subtle" href="{{ url_for('posts_list') }}">게시판 이동</a>
    </div>
    <div class="table-wrap">
      <table class="table">
        <thead><tr><th>ID</th><th>분류</th><th>제목</th><th>작성일</th></tr></thead>
        <tbody>
          {% for post in my_posts %}
          <tr>
            <td>{{ post.id }}</td>
            <td>{{ post_category_labels.get(post.category, post.category) }}</td>
            <td class="text-wrap"><a href="{{ url_for('posts_detail', post_id=post.id) }}">{{ post.title }}</a></td>
            <td>{{ post.created_at|kst_datetime('%Y-%m-%d %H:%M') }}</td>
          </tr>
          {% else %}
          <tr><td colspan="4" class="text-wrap">작성한 게시글이 없습니다.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <div class="split">
      <div>
        <p class="eyebrow">My Complaints</p>
        <h3>내가 작성한 민원</h3>
      </div>
      <a class="btn btn-subtle" href="{{ url_for('complaints_list') }}">민원 목록 이동</a>
    </div>
    <div class="table-wrap">
      <table class="table">
        <thead><tr><th>ID</th><th>유형</th><th>제목</th><th>상태</th><th>작성일</th></tr></thead>
        <tbody>
          {% for complaint in my_complaints %}
          <tr>
            <td>{{ complaint.id }}</td>
            <td>{{ complaint_category_labels.get(complaint.category, complaint.category) }}</td>
            <td class="text-wrap"><a href="{{ url_for('complaints_detail', complaint_id=complaint.id) }}">{{ complaint.title }}</a></td>
            <td><span class="badge badge-{{ complaint.status }}">{{ complaint.status }}</span></td>
            <td>{{ complaint.created_at|kst_datetime('%Y-%m-%d %H:%M') }}</td>
          </tr>
          {% else %}
          <tr><td colspan="5" class="text-wrap">작성한 민원이 없습니다.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>

<section class="card">
  <div class="split">
    <div>
      <p class="eyebrow">Medical MyData</p>
      <h2>의료 마이데이터 (목데이터)</h2>
    </div>
    <form method="post" action="{{ url_for('profile_mydata_fetch') }}" class="inline-actions">
      <label class="checkline">
        <input type="checkbox" name="consent_mydata" required>
        의료 마이데이터 수집/이용에 동의합니다.
      </label>
      <button type="submit">내 의료데이터 불러오기</button>
    </form>
  </div>

  {% if mydata_snapshot and mydata %}
    {% set visits = mydata.get('visits', []) %}
    {% set medications = mydata.get('medications', []) %}
    {% set vaccinations = mydata.get('vaccinations', []) %}
    {% set checkups = mydata.get('checkups', {}) %}
    {% set insurance = mydata.get('insurance', {}) %}
    {% set cost = mydata.get('costSummary', {}) %}
    {% set alerts = mydata.get('alerts', []) %}
    {% set profile = mydata.get('profile', {}) %}
    <p class="small">최근 동기화: {{ mydata_snapshot.fetched_at|kst_datetime }} / 출처: {{ mydata_snapshot.source }}</p>

    <div class="grid grid-3">
      <section class="quick-stat mydata-kpi">
        <span class="small">최근 진료일</span>
        <b>{{ visits[0]['date'] if visits else '-' }}</b>
      </section>
      <section class="quick-stat mydata-kpi">
        <span class="small">복약 건수</span>
        <b>{{ medications|length }}</b>
      </section>
      <section class="quick-stat mydata-kpi">
        <span class="small">1년 본인부담금</span>
        <b>{{ "{:,}".format(cost.get('outOfPocketTotal', 0)) }}원</b>
      </section>
    </div>

    <div class="grid grid-2">
      <section class="card">
        <h3>기본 의료 프로필</h3>
        <p><strong>이름</strong> {{ profile.get('name', '-') }}</p>
        <p><strong>생년월일</strong> {{ profile.get('birthDate', '-') }}</p>
        <p><strong>성별</strong> {{ profile.get('gender', '-') }}</p>
        <p><strong>혈액형</strong> {{ profile.get('bloodType', '-') }}</p>
        <p><strong>알레르기</strong> {{ profile.get('allergy', '-') }}</p>
      </section>
      <section class="card">
        <h3>보험/검진 요약</h3>
        <p><strong>보험 유형</strong> {{ insurance.get('type', '-') }}</p>
        <p><strong>자격 상태</strong> {{ insurance.get('eligibility', '-') }}</p>
        <p><strong>본인부담률</strong> {{ insurance.get('copayRate', '-') }}</p>
        <p><strong>혈압</strong> {{ checkups.get('bloodPressure', '-') }}</p>
        <p><strong>공복혈당</strong> {{ checkups.get('fastingGlucose', '-') }}</p>
        <p><strong>당화혈색소(HbA1c)</strong> {{ checkups.get('hba1c', '-') }}</p>
        <p><strong>총콜레스테롤</strong> {{ checkups.get('totalCholesterol', '-') }}</p>
        <p><strong>BMI</strong> {{ checkups.get('bmi', '-') }}</p>
      </section>
    </div>

    <div class="card">
      <h3>건강 주의 알림</h3>
      <ul>
        {% for alert in alerts %}
        <li>{{ alert }}</li>
        {% else %}
        <li>이상 징후 없음</li>
        {% endfor %}
      </ul>
    </div>

    <div class="card">
      <h3>본인부담금 추이(월별)</h3>
      <div class="table-wrap">
        <table class="table">
          <thead><tr><th>월</th><th>본인부담금</th></tr></thead>
          <tbody>
            {% for m in cost.get('monthly', []) %}
            <tr>
              <td>{{ m.month }}</td>
              <td>{{ "{:,}".format(m.outOfPocket) }}원</td>
            </tr>
            {% else %}
            <tr><td colspan="2" class="text-wrap">월별 데이터가 없습니다.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="table-wrap">
      <table class="table">
        <thead><tr><th>진료일</th><th>의료기관</th><th>진료과</th><th>진단코드</th><th>진단명</th></tr></thead>
        <tbody>
          {% for item in visits %}
          <tr>
            <td>{{ item.date }}</td>
            <td>{{ item.provider }}</td>
            <td>{{ item.department }}</td>
            <td>{{ item.diagnosisCode }}</td>
            <td class="text-wrap">{{ item.diagnosisName }}</td>
          </tr>
          {% else %}
          <tr><td colspan="5" class="text-wrap">진료 이력이 없습니다.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="grid grid-2">
      <section class="card">
        <h3>처방/복약</h3>
        <div class="table-wrap">
          <table class="table">
            <thead><tr><th>약품명</th><th>1회량</th><th>1일횟수</th><th>투약일수</th></tr></thead>
            <tbody>
              {% for med in medications %}
              <tr>
                <td class="text-wrap">{{ med.name }}</td>
                <td>{{ med.dose }}</td>
                <td>{{ med.frequencyPerDay }}</td>
                <td>{{ med.days }}</td>
              </tr>
              {% else %}
              <tr><td colspan="4" class="text-wrap">복약 정보가 없습니다.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <h3>예방접종</h3>
        <div class="table-wrap">
          <table class="table">
            <thead><tr><th>백신명</th><th>접종일</th><th>차수</th></tr></thead>
            <tbody>
              {% for shot in vaccinations %}
              <tr>
                <td>{{ shot.name }}</td>
                <td>{{ shot.date }}</td>
                <td>{{ shot.doseNo }}</td>
              </tr>
              {% else %}
              <tr><td colspan="3" class="text-wrap">접종 이력이 없습니다.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  {% else %}
    <p class="small">아직 불러온 의료 데이터가 없습니다. 동의 후 <strong>내 의료데이터 불러오기</strong>를 눌러주세요.</p>
  {% endif %}
</section>
{% endblock %}
